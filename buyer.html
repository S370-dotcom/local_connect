<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalConnect - Your Neighborhood Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple page transition */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Hide scrollbar for carousels */
        .carousel::-webkit-scrollbar {
            display: none;
        }
        .carousel {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Style for the new bottom nav */
        .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Product button transitions */
        .add-btn-container, .quantity-selector {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- 
      App Container
      This holds the entire application.
    -->
    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">

        <!-- Loading Spinner (Shown on initial load) -->
        <div id="loading-spinner" class="flex items-center justify-center min-h-screen">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-500"></div>
        </div>

        <!-- Message Box (For "Order Placed", etc.) -->
        <div id="message-box" class="hidden fixed top-10 left-1/2 -translate-x-1/2 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-all duration-300">
            <span id="message-text"></span>
        </div>

        <!-- 
          Main App Content (Hidden until Firebase auth is ready)
        -->
        <div id="main-content" class="hidden">

            <!-- 
              App Header
              This shows the location and user profile.
            -->
            <header class="sticky top-0 z-20 bg-white p-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <button id="header-back-button" class="hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div id="header-title">
                        <div class="text-xs font-medium text-gray-500">Deliver to</div>
                        <div class="flex items-center space-x-1">
                            <span class="text-lg font-bold text-gray-800">Hackathon HQ</span>
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                </div>
            </header>

            <!-- 
              ========================================
              PAGE 1: HOME
              ========================================
            -->
            <main id="page-home" class="page active p-4 space-y-6 pb-24"> <!-- Added padding for bottom nav -->
                <!-- Search Bar (Fake) -->
                <div class="relative">
                    <input type="text" placeholder="Search for stores or products..." class="w-full bg-gray-100 border-none rounded-lg py-3 px-4 pl-10 text-gray-700 focus:ring-2 focus:ring-orange-400">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <!-- Offers Banner Section -->
                <section>
                    <div class="carousel flex space-x-4 overflow-x-auto">
                        <img src="https://placehold.co/600x300/FFF0DB/F97316?text=Flat+50%25+OFF" alt="Offer 1" class="w-5/6 flex-shrink-0 rounded-xl object-cover">
                        <img src="https://placehold.co/600x300/DCFCE7/22C55E?text=Fresh+Veggies+Offer" alt="Offer 2" class="w-5/6 flex-shrink-0 rounded-xl object-cover">
                    </div>
                </section>

                <!-- Categories Section -->
                <section>
                    <h2 class="text-xl font-bold text-gray-900 mb-3">Shop by Category</h2>
                    <!-- Converted to horizontal carousel -->
                    <div id="categories-grid" class="carousel flex space-x-4 overflow-x-auto pb-2">
                        <!-- Categories will be rendered here by JS -->
                    </div>
                </section>

                <!-- Stores Near You Section -->
                <section>
                    <h2 class="text-xl font-bold text-gray-900 mb-3">Stores Near You</h2>
                    <div id="stores-list" class="space-y-4">
                        <!-- Store cards will be rendered here by JS -->
                    </div>
                </section>
                
            </main>

            <!-- 
              ========================================
              PAGE 2: STORE DETAIL
              ========================================
            -->
            <main id="page-store" class="page pb-24"> <!-- Added padding for bottom nav -->
                <!-- Store Header -->
                <div id="store-header" class="p-4 border-b border-gray-200">
                    <!-- Store name will be injected here -->
                </div>
                <!-- Products List -->
                <div id="products-list" class="p-4 space-y-4">
                    <!-- Product cards will be rendered here by JS -->
                </div>
            </main>

            <!-- 
              ========================================
              NEW BOTTOM NAVIGATION BAR
              ========================================
            -->
            <footer class="bottom-nav fixed bottom-0 inset-x-0 max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around items-center py-2 z-20">
                <button class="flex flex-col items-center text-orange-500">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    <span class="text-xs font-bold">Home</span>
                </button>
                <button class="flex flex-col items-center text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span class="text-xs">Categories</span>
                </button>
                <button class="flex flex-col items-center text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span class="text-xs">Search</span>
                </button>
                <button id="cart-nav-button" class="flex flex-col items-center text-gray-400 relative">
                    <span id="cart-nav-badge" class="hidden absolute -top-1 right-2 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="text-xs">Cart</span>
                </button>
            </footer>

            <!-- 
              ========================================
            -->
            <div id="cart-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 transition-opacity">
                <div id="cart-panel" class_="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl flex flex-col transform translate-x-full transition-transform duration-300">
                    <!-- Cart Header -->
                    <div class="flex justify-between items-center p-4 border-b border-gray-200">
                        <h2 class="text-xl font-bold">Your Cart</h2>
                        <button id="close-cart-button">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Cart Items -->
                    <div id="cart-items-list" class="flex-grow p-4 space-y-4 overflow-y-auto">
                        <!-- Cart items will be rendered here -->
                        <div id="cart-empty-message" class="text-center text-gray-500 pt-10">Your cart is empty.</div>
                    </div>

                    <!-- Cart Footer (Checkout) -->
                    <div class="p-4 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-lg font-medium text-gray-700">Subtotal:</span>
                            <span id="cart-subtotal" class="text-xl font-bold text-gray-900">₹0.00</span>
                        </div>
                        <button id="checkout-button" class="w-full bg-orange-500 text-white py-3 rounded-lg text-lg font-bold hover:bg-orange-600 disabled:bg-gray-300">
                            Place Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- 
              Floating Cart Button (REMOVED)
            -->
            <!-- 
            <button id="cart-fab" class="hidden fixed bottom-6 right-1/2 translate-x-1/2 z-20 bg-orange-500 text-white px-6 py-3 rounded-full shadow-lg flex items-center space-x-3 transform transition-all duration-300 hover:scale-105">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span id="cart-fab-info" class="font-bold"></span>
            </button>
            -->

        </div> <!-- End #main-content -->
    </div> <!-- End #app-container -->

    <!-- 
      ========================================
      JAVASCRIPT (NO FIREBASE)
      ========================================
    -->
    <script type="module">
        // --- HACKATHON DEMO DATA ---
        // Data is now loaded directly from here.
        const CATEGORIES = [
            { id: "cat1", name: "Groceries", image: "https://placehold.co/150x150/FFF0DB/F97316?text=Groceries" },
            { id: "cat2", name: "Vegetables", image: "https://placehold.co/150x150/DCFCE7/22C55E?text=Veggies" },
            { id: "cat3", name: "Street Food", image: "https://placehold.co/150x150/FEF9C3/EAB308?text=Food" },
            { id: "cat4", name: "Dairy", image: "https://placehold.co/150x150/E0F2FE/0EA5E9?text=Dairy" },
            { id: "cat5", name: "Fruits", image: "https://placehold.co/150x150/FEE2E2/EF4444?text=Fruits" },
            { id: "cat6", name: "Pharmacy", image: "https://placehold.co/150x150/E0E7FF/6366F1?text=Meds" },
        ];

        const MOCK_STORES = [
            { id: "store1", name: "Gupta Kirana Store", category: "Groceries", image: "https://placehold.co/600x400/FFF0DB/F97316?text=Gupta+Kirana", deliveryTime: "15-20 min" },
            { id: "store2", name: "Sharma Fresh Vegetables", category: "Vegetables", image: "https://placehold.co/600x400/DCFCE7/22C55E?text=Sharma+Veggies", deliveryTime: "10-15 min" },
            { id: "store3", name: "Raju's Pani Puri Stall", category: "Street Food", image: "https://placehold.co/600x400/FEF9C3/EAB308?text=Raju's+Stall", deliveryTime: "5-10 min" },
            { id: "store4", name: "Modern Dairy", category: "Dairy", image: "https://placehold.co/600x400/E0F2FE/0EA5E9?text=Modern+Dairy", deliveryTime: "10-15 min" },
        ];

        const MOCK_PRODUCTS = [
            // Gupta Kirana
            { storeId: "store1", name: "Parle-G Biscuit (100g)", price: 10, image: "https://placehold.co/100x100/FDE68A/F97316?text=Parle-G" },
            { storeId: "store1", name: "Lays Classic Chips", price: 20, image: "https://placehold.co/100x100/FDE68A/F97316?text=Lays" },
            { storeId: "store1", name: "Amul Butter (100g)", price: 55, image: "https://placehold.co/100x100/FDE68A/F97316?text=Butter" },
            { storeId: "store1", name: "Coca-Cola (500ml)", price: 40, image: "https://placehold.co/100x100/FDE68A/F97316?text=Coke" },
            // Sharma Vegetables
            { storeId: "store2", name: "Fresh Tomatoes (1kg)", price: 40, image: "https://placehold.co/100x100/BBF7D0/22C55E?text=Tomatoes" },
            { storeId: "store2", name: "Onions (1kg)", price: 30, image: "https://placehold.co/100x100/BBF7D0/22C55E?text=Onions" },
            { storeId: "store2", name: "Potatoes (1kg)", price: 25, image: "https://placehold.co/100x100/BBF7D0/22C55E?text=Potatoes" },
            { storeId: "store2", name: "Coriander (Bunch)", price: 10, image: "https://placehold.co/100x100/BBF7D0/22C55E?text=Coriander" },
            // Raju's Pani Puri
            { storeId: "store3", name: "Pani Puri (1 Plate)", price: 30, image: "https://placehold.co/100x100/FEF08A/EAB308?text=Pani+Puri" },
            { storeId: "store3", name: "Dahi Puri (1 Plate)", price: 40, image: "https://placehold.co/100x100/FEF08A/EAB308?text=Dahi+Puri" },
            { storeId: "store3", name: "Samosa (2 pcs)", price: 25, image: "https://placehold.co/100x100/FEF08A/EAB308?text=Samosa" },
            // Modern Dairy
            { storeId: "store4", name: "Amul Gold Milk (500ml)", price: 33, image: "https://placehold.co/100x100/BAE6FD/0EA5E9?text=Milk" },
            { storeId: "store4", name: "Nestle Dahi (200g)", price: 30, image: "https://placehold.co/100x100/BAE6FD/0EA5E9?text=Dahi" },
            { storeId: "store4", name: "Britannia Cheese Slices", price: 75, image: "https://placehold.co/100x100/BAE6FD/0EA5E9?text=Cheese" },
        ];
        // --- END OF DEMO DATA ---

        // App State
        let currentUserId = null; // We still use this, but just set it to a demo value
        let storesCache = [];
        let productsCache = {}; // Cache products by storeId
        let cart = []; // Array of product objects
        let currentStoreId = null;

        // DOM Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainContent = document.getElementById('main-content');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        // Pages
        const pageHome = document.getElementById('page-home');
        const pageStore = document.getElementById('page-store');
        const allPages = document.querySelectorAll('.page');

        // Header Elements
        const headerTitle = document.getElementById('header-title');
        const headerBackButton = document.getElementById('header-back-button');

        // Home Page Elements
        const categoriesGrid = document.getElementById('categories-grid');
        const storesList = document.getElementById('stores-list');

        // Store Page Elements
        const storeHeader = document.getElementById('store-header');
        const productsList = document.getElementById('products-list');
        
        // Cart Elements
        const cartModal = document.getElementById('cart-modal');
        const cartPanel = document.getElementById('cart-panel');
        const closeCartButton = document.getElementById('close-cart-button');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartEmptyMessage = document.getElementById('cart-empty-message');
        const cartSubtotal = document.getElementById('cart-subtotal');
        const checkoutButton = document.getElementById('checkout-button');
        // const cartFab = document.getElementById('cart-fab'); // Removed
        // const cartFabInfo = document.getElementById('cart-fab-info'); // Removed
        const cartNavButton = document.getElementById('cart-nav-button');
        const cartNavBadge = document.getElementById('cart-nav-badge');


        // --- HELPER FUNCTIONS ---

        /**
         * Shows a toast-like message at the top of the screen.
         * @param {string} message - The text to display.
         * @param {boolean} [isError=false] - If true, shows a red error style.
         */
        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Navigates to a specific page, hiding all others.
         * @param {string} pageId - The ID of the page to show ('page-home' or 'page-store').
         */
        function showPage(pageId) {
            allPages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'page-home') {
                headerTitle.classList.remove('hidden');
                headerBackButton.classList.add('hidden');
            } else {
                headerTitle.classList.add('hidden');
                headerBackButton.classList.remove('hidden');
            }
        }
        
        /**
         * Formats a number as Indian Rupees.
         * @param {number} amount - The amount in numbers.
         * @returns {string} - e.g., "₹10.00"
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        // --- RENDER FUNCTIONS ---
        
        /**
         * Renders the category tiles on the home page.
         */
        function renderCategories() {
            categoriesGrid.innerHTML = ''; // Clear existing
            CATEGORIES.forEach(cat => {
                const catEl = document.createElement('div');
                // Updated classes for horizontal carousel
                catEl.className = "flex flex-col items-center space-y-2 cursor-pointer w-20 flex-shrink-0";
                catEl.innerHTML = `
                    <img src="${cat.image}" alt="${cat.name}" class="w-16 h-16 rounded-full object-cover shadow-sm">
                    <span class="font-medium text-gray-800 text-sm text-center">${cat.name}</span>
                `;
                // In a real app, this would filter stores.
                catEl.onclick = () => showMessage(`Showing ${cat.name} stores...`);
                categoriesGrid.appendChild(catEl);
            });
        }

        /**
         * Renders the list of stores on the home page.
         */
        function renderStores() {
            storesList.innerHTML = ''; // Clear existing
            if (storesCache.length === 0) {
                storesList.innerHTML = `<p class="text-gray-500 text-center">No stores found!</p>`;
                return;
            }
            
            storesCache.forEach(store => {
                const storeEl = document.createElement('div');
                storeEl.className = "bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow";
                storeEl.innerHTML = `
                    <img class="h-32 w-full object-cover" src="${store.image}" alt="${store.name}">
                    <div class="p-4">
                        <h3 class="text-lg font-bold text-gray-900">${store.name}</h3>
                        <p class="text-sm text-gray-500">${store.category}</p>
                        <div class="flex items-center space-x-2 mt-2">
                            <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-sm font-medium text-gray-700">${store.deliveryTime}</span>
                        </div>
                    </div>
                `;
                storeEl.onclick = () => openStorePage(store.id);
                storesList.appendChild(storeEl);
            });
        }
        
        /**
         * Rndrs the products for a specific store.
         */
        function renderProducts() {
            productsList.innerHTML = ''; // Clear
            const storeId = currentStoreId;
            const products = productsCache[storeId] || [];

            if (products.length === 0) {
                productsList.innerHTML = `<p class="text-gray-500 text-center">No products found for this store.</p>`;
                return;
            }
            
            products.forEach(product => {
                // Check quantity in cart
                const quantityInCart = cart.filter(item => item.id === product.id).length;

                const productEl = document.createElement('div');
                productEl.className = "flex items-center justify-between p-3 bg-white rounded-lg shadow-sm";
                productEl.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${product.image}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover">
                        <div>
                            <h4 class="font-bold text-gray-800">${product.name}</h4>
                            <p class="font-medium text-gray-600">${formatCurrency(product.price)}</p>
                        </div>
                    </div>
                    <!-- This container holds both ADD and Quantity buttons -->
                    <div class="add-btn-container w-24 text-right">
                        <!-- ADD Button (shown if quantity is 0) -->
                        <button 
                            data-product-id="${product.id}" 
                            class="add-to-cart-btn text-orange-500 border border-orange-500 rounded-lg px-4 py-1 font-bold hover:bg-orange-500 hover:text-white transition-colors ${quantityInCart > 0 ? 'hidden' : ''}"
                        >
                            ADD
                        </button>
                        
                        <!-- Quantity Selector (shown if quantity > 0) -->
                        <div 
                            class="quantity-selector flex items-center justify-between border border-orange-500 rounded-lg w-full ${quantityInCart > 0 ? '' : 'hidden'}"
                        >
                            <button data-product-id="${product.id}" class="remove-from-cart-btn text-orange-500 font-bold w-1/3 py-1">-</button>
                            <span class="item-quantity font-bold text-sm w-1/3 text-center">${quantityInCart}</span>
                            <button data-product-id="${product.id}" class="add-to-cart-btn text-orange-500 font-bold w-1/3 py-1">+</button>
                        </div>
                    </div>
                `;
                productsList.appendChild(productEl);
            });
        }
        
        /**
         * Renders the items currently in the cart.
         */
        function renderCart() {
            cartItemsList.innerHTML = ''; // Clear
            
            if (cart.length === 0) {
                cartEmptyMessage.classList.remove('hidden');
                // cartFab.classList.add('hidden'); // Removed
                checkoutButton.disabled = true;
                cartSubtotal.textContent = formatCurrency(0);
                cartNavBadge.classList.add('hidden'); // Hide badge
                cartNavBadge.textContent = '0';
                return;
            }

            cartEmptyMessage.classList.add('hidden');
            checkoutButton.disabled = false;
            
            let subtotal = 0;
            const cartItemGroups = {};

            // Group items by ID
            cart.forEach(item => {
                if (!cartItemGroups[item.id]) {
                    cartItemGroups[item.id] = { ...item, quantity: 0 };
                }
                cartItemGroups[item.id].quantity += 1;
                subtotal += item.price;
            });

            // Render grouped items
            Object.values(cartItemGroups).forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = "flex items-center justify-between";
                itemEl.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
                        <div>
                            <h5 class="font-medium">${item.name}</h5>
                            <p class="text-sm text-gray-500">${formatCurrency(item.price)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-product-id="${item.id}" class="remove-from-cart-btn text-gray-500">-</button>
                        <span class="font-bold w-6 text-center">${item.quantity}</span>
                        <button data-product-id="${item.id}" class="add-to-cart-btn text-orange-500">+</button>
                    </div>
                `;
                cartItemsList.appendChild(itemEl);
            });
            
            cartSubtotal.textContent = formatCurrency(subtotal);
            
            // Update Bottom Nav Badge
            cartNavBadge.textContent = cart.length;
            cartNavBadge.classList.remove('hidden');

            // Update FAB (REMOVED)
            // cartFabInfo.textContent = `${cart.length} item${cart.length > 1 ? 's' : ''} | ${formatCurrency(subtotal)}`;
            // cartFab.classList.remove('hidden');
        }


        // --- MOCK DATA FUNCTIONS ---

        /**
         * Fetches all stores from the MOCK_STORES constant.
         */
        async function fetchStores() {
            try {
                // Simulate network delay for demo
                await new Promise(resolve => setTimeout(resolve, 500)); 
                
                storesCache = MOCK_STORES; // Use mock data directly
                
                console.log("Fetched stores:", storesCache);
                renderStores();
                
            } catch (error) {
                console.error("Error fetching stores:", error);
                showMessage("Error fetching stores. Check console.", true);
            }
        }
        
        /**
         * "Places" the order by logging it to the console.
         * This is the final step of the demo!
         */
        async function placeOrder() {
            if (cart.length === 0) return;
            
            checkoutButton.disabled = true;
            checkoutButton.textContent = "Placing Order...";
            
            try {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const subtotal = cart.reduce((acc, item) => acc + item.price, 0);
                
                const orderData = {
                    userId: "demo-user", // Hardcode a user
                    storeId: currentStoreId,
                    items: cart,
                    subtotal: subtotal,
                    status: "NEW",
                    createdAt: new Date().toISOString() // Use JS Date
                };
                
                console.log("Order Placed (Demo):", orderData);
                showMessage("Order Placed Successfully!");
                
                // Reset cart and UI
                cart = [];
                closeCart();
                renderCart(); // This will hide the FAB
                
            } catch (error)
 {
                console.error("Error placing order:", error);
                showMessage("Error placing order. Check console.", true);
            } finally {
                checkoutButton.disabled = false;
                checkoutButton.textContent = "Place Order";
            }
        }

        // --- APP LOGIC & NAVIGATION ---

        /**
         * Opens the detail page for a specific store.
         * @param {string} storeId - The document ID of the store.
         */
        function openStorePage(storeId) {
            currentStoreId = storeId;
            const store = storesCache.find(s => s.id === storeId);
            
            if (!store) {
                console.error("Store not found:", storeId);
                return;
            }
            
            // Render store header
            storeHeader.innerHTML = `
                <h2 class="text-2xl font-bold">${store.name}</h2>
                <p class="text-gray-500">${store.category}</p>
            `;
            
            productsList.innerHTML = `<p class="text-center">Loading products...</p>`;
            
            showPage('page-store');
            fetchProducts(storeId);
        }

        // Re-writing fetchProducts to add unique IDs, as this is the source of the "add to cart" bug
        async function fetchProducts(storeId) {
            // Use cache if available
            if (productsCache[storeId]) {
                renderProducts();
                return;
            }
            
            try {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 300)); 
                
                const products = MOCK_PRODUCTS.filter(p => p.storeId === storeId)
                    .map((p, index) => ({
                        ...p,
                        id: `${storeId}-prod-${index}` // Create a unique demo ID
                    }));
                
                productsCache[storeId] = products; // Cache the result
                console.log(`Fetched products for ${storeId}:`, products);
                renderProducts();
                
            } catch (error) {
                console.error("Error fetching products:", error);
                showMessage("Error fetching products. Check console.", true);
            }
        }
        
        // Re-writing handleAddProduct to be simpler now that IDs are unique
        function handleAddProduct(productId) {
            const products = productsCache[currentStoreId] || [];
            const product = products.find(p => p.id === productId);
            
            if (product) {
                cart.push(product);
                renderCart();
                renderProducts(); // <-- ADD THIS LINE
                showMessage(`${product.name} added to cart!`);
            } else {
                console.error("Product not found to add:", productId);
            }
        }
        
        /**
         * Removes one instance of a product from the cart.
         * @param {string} productId - The document ID of the product.
         */
        function handleRemoveProduct(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const removedItem = cart.splice(itemIndex, 1)[0];
                renderCart();
                renderProducts(); // <-- ADD THIS LINE
                showMessage(`${removedItem.name} removed.`);
            }
        }

        // Cart Modal Logic
        function openCart() {
            cartModal.classList.remove('hidden');
            setTimeout(() => {
                cartPanel.classList.remove('translate-x-full');
            }, 10); // Start transition
        }

        function closeCart() {
            cartPanel.classList.add('translate-x-full');
            setTimeout(() => {
                cartModal.classList.add('hidden');
            }, 300); // Wait for transition to end
        }
        
        // --- INITIALIZATION ---

        /**
         * Main app initialization function.
         */
        async function initializeApp() {
            console.log("User authenticated: demo-user");
            currentUserId = "demo-user"; // Set demo user
            
            // Render static parts
            renderCategories();

            // Fetch initial data
            await fetchStores(); // Await this so stores load before UI shows
            
            // Attach all event listeners
            
            // Navigation
            headerBackButton.onclick = () => showPage('page-home');

            // Cart
            // cartFab.onclick = openCart; // Removed
            cartNavButton.onclick = openCart; // Added
            closeCartButton.onclick = closeCart;
            cartModal.onclick = (e) => {
                // Close if clicking on the background overlay
                if (e.target === cartModal) {
                    closeCart();
                }
            };
            checkoutButton.onclick = placeOrder;
            
            // Dynamic event listeners (using event delegation)
            document.body.addEventListener('click', (e) => {
                // Add to Cart (on store page or in cart)
                const addBtn = e.target.closest('.add-to-cart-btn');
                if (addBtn) {
                    const productId = addBtn.dataset.productId;
                    handleAddProduct(productId);
                }
                
                // Remove from Cart (in cart modal)
                const removeBtn = e.target.closest('.remove-from-cart-btn');
                if (removeBtn) {
                    const productId = removeBtn.dataset.productId;
                    handleRemoveProduct(productId);
                }
            });

            // Show the main content
            loadingSpinner.classList.add('hidden');
            mainContent.classList.remove('hidden');
            console.log("App initialized and ready.");
        }

        // --- START THE APP ---
        try {
            // No Firebase, just start the app
            initializeApp();
        } catch (error) {
            console.error("App Initialization Error:", error);
            loadingSpinner.innerHTML = `<p class="text-red-500 text-center">Failed to initialize app. Check console.</p>`;
        }

    </script>
</body>
</html>